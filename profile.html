<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Language" content="ar" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <script src="https://cdn.auth0.com/js/lock/11.5.2/lock.min.js"></script>
  <link rel="stylesheet" type="text/css" href="hanadi.css" />
  <link rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAS5SURBVGhD7VhbT1xVFEYfjA8an0xM1MQ/4Ksm+sBD58acw8DA3jNcLMzItOWSthJMiwIFWrAYi1qTqrUxwXgjFkNbW6SWak1Te1GkUIECLdOBKaXlDgWsNS7XnrPPmTNwhtBxmCHmfMkXCPuctb5vr7332pwEHTp06NChQ4eO/zESKX3MIBCbUSTlRpF+YBRII/7+iUkku02iI9ViIU/yR9cnjMmOl1HwcRT/p0mksALvo6kTRjHdxF9dHzClOJ9lwtRizckO8BQUw443q6Gsci+U7NwF7s1bA39XP2cSyGlzivM5Hip+YLOKVbgjC9tcVAItrafh9u0JWFy8r3Byag6Ghkeg9+oAfPFVE7y6ZbtiBt+fYUuRh4w9AvtAIH8zMXaHC062/QwLC3+FGFBzfv4ejI6Ogc/nhxs3huHLxiawkY2yIbbcnDx07GC0pr9oFOg8E5GX/xp4vTc1xWtxfHw6YIbx4qUOyHbnS5URyD2TNf0lnmLtkZiY+yguh2ss+SvuAvD7RzUFr8QpXGqymY6OLnBu3MQrQ/w2m+1xnmptgTNXw5ImpWRAT+91TaGrodrMqbYzykFgtJKDZoFWYZ4jJoGeMVnJYZZTEHKe5hL+O9hs4azdZQkPHGzQFPggHBubUsyUVtTwqoQnGhqxCE7K5UQOg0g8LKA1NXPZyRQpR0buwMeHPgOLzRki2mxzgGDPBMvSI5uNifQCpfQRLuvBgTPyAwtUVbNPU1QkrN//kSLQ7siFPW/VQ3dPf2BsYmImUK1z53+Dsl21S0yRWxGbkXtG87HWZYIiZba7MCCsvGovCp9dNj41fVdZft29/ZCZu0UxY0yml7m01UPq4FKAy509yxJGyqt9Xmj78eyKPUi9l7zeIchyFShmNoikkEsMj8rKyoexhG6sxEV8CZuW9HKqIwdq394Pff1ezcTRJjM57L+lmOnruw5JtgxuhsxwudqwWulTeBc6L4vXojU1AxoPH9VMHm2qGyljTd27QR3hGqnBQJ/Ajd0tP/h6aRV8f/InuPJHH/za3gUNn38DjmyPEuiXC+2ayaPJubnFECOdXT3s9JI0WOnXXHoosBEdYg+wJtXU3KIZmM0Qu9nSLA/0D/g0n4k21UYYBXtWwAhO+iUuPQiLxf4MDgQug9FoetEku0GrjaRluKSKCOQalx8EbuxCNiimZQVOC62A8aLaBGO2SzqKceIbufwg0MiHbHBbSZlmsHhx6R4ZGBgEUV5aIi3m8oPA46yBDZaW79EMGC/KXV7mt83HpWWF3JBEnufyg8CK1LHBnLwizYDxIvt3QTbBmqJr01ZuhPRw6aHAa7NFdtr++xXNoLHm5ORsSDX2vXdAqQbuD8Klh4JdxHDQyx7Ky98O4xPTmsFjxdnZBRgauqlUov794CUTT6tjKPkhSbkG0IgdH/xHNhOvykxPz4MPTQwO+uDod63gyS9WVYJ2ssbNJYcHmnlDNsOY4ykKNMDq2vo1Z1XNO1BRXQc7y3ZDwbYd6o8UEgXasioTMtAMxfL5QoLEkwIZNCTTTHaZ5RJXD/axwWxNT5M+f9IjeKqdihXxRDqBPz/FvBVo4gWUE34/6NChQ4cOHTp0rFckJPwL4qQcu4ZL4ykAAAAASUVORK5CYII=" />
  <title>أنظمة غيمة - Cloud Systems - شكرًا لك</title>
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
  <script type="text/javascript" src="js/common.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-56731261-3"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-56731261-3');
  </script>
</head>
<body>
  <nav>
    <ul>
      <li>
        <a href="index.html">الرئيسيّة</a>
      </li>
      <li>
        <a id="logout" href="#">تسجيل الخروج</a>
      </li>
    </ul>
  </nav>
  <div class="container">
    <div id="not-logged-in-yet">
      لم تقم بتسجيل الدخول بعد. <a id="login" href="#">تسجيل الدخول</a>.
    </div>
    <div id="invalid-login">
      تأكّد من توثيق البريد الإلكتروني للعضويّة من خلال اتّباع التعليمات التي أُرسلت إلى بريدك الإلكتروني. تأكّد كذلك من كون العضويّة مسجّلة في برنامج التدريب الجاري. حاول أخيرًا مسح ملفات تعريف الارتباط (Cookies) وسجّل الدخول مرّةً أخرى بعد توثيق البريد الإلكتروني.
    </div>
    <div id="not-verified-email">
      تمّ إرسال رسالة طلب تفعيل البريد الإلكتروني إلى بريدك الإلكتروني، الرجاء تفعيل البريد الإلكتروني من خلال تنفيذ ما ورد فيها.
    </div>
    <div id="loading">
      لحظات من فضلك...
    </div>
    <div id="logged-in-as-contributor">
      <img id="contributor-picture" src="" />
      <h3 id="contributor-fullname">أحمد العجمي </h3><small>(مُساهِم)</small>
      <a id="contributor-email" href="#">a.alajmi@gmail.com</a>
    </div>
    <div id="logged-in-as-trainee">
      <img id="trainee-picture" src="" />
      <h3 id="trainee-fullname">أحمد العجمي </h3><small>(مُساهِم)</small>
      <a id="trainee-email" href="#">a.alajmi@gmail.com</a>
    </div>
    <div class="copyrights">
      (ح) جميع الحقوق محفوظة لمؤسّسة أنظمة غيمة (Cloud Systems).
    </div>
  </div>
  <script type="text/javascript">

    // TODO: Verify email.
    var notLoggedInYet = document.getElementById('not-logged-in-yet');
    var invalidLogin = document.getElementById('invalid-login');
    var notVerifiedEmail = document.getElementById('not-verified-email');
    var loading = document.getElementById('loading');
    var loggedAsContributor = document.getElementById('logged-as-contributor');
    var loggedAsTrainee = document.getElementById('logged-as-trainee');
    var logout = document.getElementById('logout');
    var login = document.getElementById('login');
    var contributorPicture = document.getElementById('contributor-picture');
    var contributorFullname = document.getElementById('contributor-fullname');
    var contributorEmail = document.getElementById('contributor-email');
    var traineePicture = document.getElementById('trainee-picture');
    var traineeFullname = document.getElementById('trainee-fullname');
    var traineeEmail = document.getElementById('trainee-email');

    // Hide the error message initially.
    notLoggedInYet.style.display = 'none';
    invalidLogin.style.display = 'none';
    notVerifiedEmail.style.display = 'none';
    loading.style.display = 'none';
    loggedAsContributor.style.display = 'none';
    loggedAsTrainee.style.display = 'none';

    // Initializing our Auth0Lock
    var options = {
      theme: {
        logo: 'https://avatars3.githubusercontent.com/u/30606298?s=150&v=4',
      },
      languageDictionary: {
        title: 'CloudSystems'
      },
    };
    var lock = new Auth0Lock(
      'I6A29coC25s2hH-QBMfmMLdyiGQJ3gZ1',
      'cloudsystems.auth0.com',
      options
    );

    // Listening for the authenticated event
    lock.on("authenticated", function(authResult) {
      lock.getUserInfo(authResult.accessToken, function(error, profile) {
        if (error) {
          Cookies.remove('accessToken');
        } else {
          Cookies.set('accessToken', authResult.accessToken, { expires: 7 });
        }
        window.location.reload();
      });
    });

    document.getElementById('logout').addEventListener('click', function() {
      Cookies.remove('accessToken');
      lock.logout({
        returnTo: window.location.href,
      });
    });

    document.getElementById('login').addEventListener('click', function() {
      lock.show();
    });

    function handleUI() {
      var accessToken = Cookies.get('accessToken');
      if (!accessToken) {
        logout.style.display = 'none';
        notLoggedInYet.style.display = 'block';
        return lock.show();
      }
      logout.style.display = 'block';
      checkIfContributor(accessToken);
    }

    function checkIfContributor(accessToken) {
      var http = new XMLHttpRequest();
      var url = 'https://d2hbxkrooc.execute-api.eu-west-1.amazonaws.com/dev/auth/contributors';

      loading.style.display = 'block';
      http.onreadystatechange = function() {
        if (http.readyState == XMLHttpRequest.DONE) {
          loading.style.display = 'none';
          if (http.status == 200) {
            var response = JSON.parse(http.response);
            Cookies.set('email', response.email, { expires: 7 });
            // contributorPicture.src = response.picture;
            // contributorFullname.innerHTML = response.fullname;
            // contributorEmail.innerHTML = response.email;
            // loggedAsContributor.style.display = 'block';
            var redirectUri = Cookies.get('redirectUri');
            if (!redirectUri) {
              redirectUri = '/index.html';
            }
            window.location.href = redirectUri;
          } else {
            checkIfTrainee(accessToken);
          }
        }
      }

      http.open('GET', url);

      // Set some headers.
      http.setRequestHeader('Content-type', 'application/json');
      http.setRequestHeader('Accept', 'application/json');
      http.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      http.send();
    }

    function checkIfTrainee(accessToken) {
      var http = new XMLHttpRequest();
      var url = 'https://d2hbxkrooc.execute-api.eu-west-1.amazonaws.com/dev/auth/trainees';

      loading.style.display = 'block';
      http.onreadystatechange = function() {
        if (http.readyState == XMLHttpRequest.DONE) {
          loading.style.display = 'none';
          if (http.status == 200) {
            var response = JSON.parse(http.response);
            Cookies.set('email', response.email, { expires: 7 });
            // traineePicture.src = response.picture;
            // traineeFullname.innerHTML = response.fullname;
            // traineeEmail.innerHTML = response.email;
            // loggedAsTrainee.style.display = 'block';
            // loggedAsContributor.style.display = 'none';
            var redirectUri = Cookies.get('redirectUri');
            if (!redirectUri) {
              redirectUri = '/index.html';
            }
            window.location.href = redirectUri;
          } else {
            invalidLogin.style.display = 'block';
          }
        }
      }

      http.open('GET', url);

      // Set some headers.
      http.setRequestHeader('Content-type', 'application/json');
      http.setRequestHeader('Accept', 'application/json');
      http.setRequestHeader('Authorization', 'Bearer ' + accessToken);
      http.send();
    }

    handleUI();

  </script>
</body>
</html>
